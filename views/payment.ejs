<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh toán - Beru Bike</title>
  <link rel="stylesheet" href="/style/payment.css">
  <link rel="stylesheet" href="/style/footer.css">
  <link rel="stylesheet" href="/style/header.css">
  <link rel="icon" type="image/x-icon" href="/image/logo/favicon.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Style riêng cho logo thanh toán */
    .payment-option img {
      vertical-align: middle;
      margin-right: 10px;
    }

    /* [MỚI] Style cho 3 ô chọn địa lý */
    .address-selectors {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
    }
    .address-selectors select {
        flex: 1; /* Chia đều 3 ô */
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        outline: none;
        background: #fff;
        font-size: 14px;
        color: #333;
    }
    .address-selectors select:focus {
        border-color: #ee4d2d;
    }
    .address-selectors select:disabled {
        background-color: #f9f9f9;
        cursor: not-allowed;
    }

    /* Mobile: Xếp dọc */
    @media (max-width: 768px) {
        .address-selectors {
            flex-direction: column;
        }
    }
  </style>
</head>

<body>
  <%- include('header') %>

    <div class="container">
      <div class="checkout-progress">
        <div class="progress-step completed">
          <div class="step-circle">1</div>
          <span>Giỏ hàng</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
          <div class="step-circle">2</div>
          <span>Thanh toán</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
          <div class="step-circle">3</div>
          <span>Hoàn tất</span>
        </div>
      </div>

      <div class="checkout">
        <div class="checkout-left">
          <div class="box order-review">
            <div class="cart-header">
              <h3><i class="fas fa-shopping-bag"></i> Đơn hàng của bạn</h3>
              <span class="item-count">(<span id="cart-qty-display">
                  <%= cartItems.length %>
                </span> sản phẩm)</span>
            </div>

            <div id="cart-items-container">
              <% if (cartItems && cartItems.length> 0) { %>
                <% cartItems.forEach(item=> { %>
                  <div class="cart-item">
                    <img src="<%= item.image || '/image/icon/image.png' %>" alt="<%= item.name %>"
                      class="item-thumbnail">
                    <div class="item-info">
                      <p class="item-name">
                        <%= item.name %>
                      </p>
                      <p class="item-detail">Số lượng: <strong>
                          <%= item.quantity || 1 %>
                        </strong></p>
                      <% if(item.stock !==undefined) { %>
                        <small style="color: #666;">Kho còn: <%= item.stock %></small>
                        <% } %>
                    </div>
                    <div class="item-price-section">
                      <p class="item-price">₫<%= (item.price || 0).toLocaleString('vi-VN') %>
                      </p>
                      <p class="item-subtotal">Tổng: <strong>₫<%= ((item.price || 0) * (item.quantity ||
                          1)).toLocaleString('vi-VN') %></strong></p>
                    </div>
                  </div>
                  <% }); %>
                    <% } else { %>
                      <div class="empty-cart-msg">
                        <i class="fas fa-inbox"></i>
                        <p>Giỏ hàng của bạn đang trống!</p>
                        <a href="/checkout" class="back-link">← Quay lại giỏ hàng</a>
                      </div>
                      <% } %>
            </div>
          </div>

          <div class="box customer-info-box">
            <h3><i class="fas fa-user"></i> Thông tin giao hàng</h3>
            <form id="customerForm" class="customer-form" novalidate>
              <div class="form-row">
                <div class="form-group">
                  <label for="fullName">Họ và tên <span class="required">*</span></label>
                  <input type="text" id="fullName" name="fullName"
                    value="<%= user ? (user.fullName || user.username) : '' %>" placeholder="Họ và Tên" required>
                  <span class="error-message" id="fullName-error" style="display: none; color: red;"></span>
                </div>
                <div class="form-group">
                  <label for="phone">Số điện thoại <span class="required">*</span></label>
                  <input type="tel" id="phone" name="phone" value="<%= user ? user.phone : '' %>"
                    placeholder="0123 456 789" required pattern="[0-9]{10,11}">
                  <span class="error-message" id="phone-error" style="display: none; color: red;"></span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full">
                    <label>Khu vực giao hàng <span class="required">*</span></label>
                    <div class="address-selectors">
                        <select id="province" name="province">
                            <option value="">-- Chọn Tỉnh/Thành --</option>
                        </select>
                        <select id="district" name="district" disabled>
                            <option value="">-- Chọn Quận/Huyện --</option>
                        </select>
                        <select id="ward" name="ward" disabled>
                            <option value="">-- Chọn Phường/Xã --</option>
                        </select>
                    </div>
                    <span class="error-message" id="area-error" style="display: none; color: red;"></span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full">
                  <label for="specificAddress">Địa chỉ cụ thể <span class="required">*</span></label>
                  <textarea id="specificAddress" name="specificAddress" placeholder="Số nhà, tên đường, ấp/khóm..." required
                    minlength="5"><%= user ? user.address : '' %></textarea>
                  <span class="error-message" id="address-error" style="display: none; color: red;"></span>
                  <span class="form-hint">Ví dụ: Số 10, Đường 3/2 (Không cần nhập lại Tỉnh/Thành)</span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full">
                  <label for="note">Ghi chú đơn hàng (Tùy chọn)</label>
                  <textarea id="note" name="note" placeholder="Ví dụ: Giao hàng vào sáng, có chuông cửa..."></textarea>
                </div>
              </div>
            </form>
          </div>

          <div class="box payment-box">
            <h3><i class="fas fa-credit-card"></i> Chọn hình thức thanh toán</h3>
            <div class="payment-options">

              <label class="payment-option">
                <input type="radio" name="payment" value="cod" checked>
                <div class="option-content">
                  <span class="option-title">
                    <img src="/image/icon/cod.png" alt="" width="24"> Thanh toán khi nhận hàng (COD)
                  </span>
                  <span class="option-desc">Thanh toán bằng tiền mặt khi nhận hàng</span>
                </div>
                <span class="checkmark"></span>
              </label>

              <label class="payment-option">
                <input type="radio" name="payment" value="vnpay">
                <div class="option-content">
                  <span class="option-title">
                    <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/6/0oxhzjmxbksr1686814746087_1566974273.png"
                      alt="" width="24"> VNPay / Thẻ ATM / QR Code
                  </span>
                  <span class="option-desc">Thanh toán an toàn qua cổng VNPay</span>
                </div>
                <span class="checkmark"></span>
              </label>

            </div>
          </div>
        </div>

        <div class="checkout-right">
          <div class="box order-total sticky-box">

            <div id="order-summary-box" class="summary active">
              <h3><i class="fas fa-receipt"></i> Tóm tắt đơn hàng</h3>
              <div class="summary">
                <div class="summary-row">
                  <span>Tạm tính:</span>
                  <span id="subtotal" class="subtotal-value">₫<%= (subtotal || 0).toLocaleString('vi-VN') %></span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-row total-row">
                  <span>Tổng cộng:</span>
                  <span id="totalAmount" class="total-amount">₫<%= (total || 0).toLocaleString('vi-VN') %></span>
                </div>
                <small class="shipping-notice"><i class="fas fa-info-circle"></i> Phí vận chuyển được tính ở bước thanh
                  toán</small>
              </div>

              <% if (cartItems && cartItems.length> 0) { %>
                <button id="place-order-btn" class="btn-buy" onclick="placeOrder()">
                  <span>ĐẶT HÀNG NGAY</span> <i class="fas fa-check"></i>
                </button>
                <a href="/checkout" class="btn-back">← Quay lại giỏ hàng</a>
                <% } else { %>
                  <button class="btn-buy" disabled><span>GIỎ HÀNG TRỐNG</span></button>
                  <% } %>

                    <div class="trust-badges">
                      <div class="badge"><i class="fas fa-lock"></i> Thanh toán an toàn</div>
                      <div class="badge"><i class="fas fa-truck"></i> Giao hàng nhanh</div>
                    </div>

                    <% if (!user) { %>
                      <div class="guest-notice">
                        <p><i class="fas fa-info-circle"></i> Bạn đang mua với tư cách khách vãng lai. Đăng ký để quản
                          lý đơn hàng!</p>
                        <a href="/auth/signup" class="btn-secondary">Đăng ký ngay</a>
                      </div>
                      <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-bottom">
        <p>© 2025 Xe Đạp Beru Bike - Chất lượng & Uy tín</p>
      </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>
      // ==========================================
      // 1. XỬ LÝ API ĐỊA LÝ VIỆT NAM (Provinces)
      // ==========================================
      const host = "https://provinces.open-api.vn/api/";
      
      var callAPI = (api) => {
          return axios.get(api).then((response) => {
              renderData(response.data, "province");
          });
      }
      
      callAPI(host + "?depth=1"); // Load Tỉnh/Thành ngay khi vào trang

      var callApiDistrict = (api) => {
          return axios.get(api).then((response) => {
              renderData(response.data.districts, "district");
          });
      }
      
      var callApiWard = (api) => {
          return axios.get(api).then((response) => {
              renderData(response.data.wards, "ward");
          });
      }

      var renderData = (array, select) => {
          let row = ' <option value="">-- Chọn ' + (select === "province" ? "Tỉnh/Thành" : (select === "district" ? "Quận/Huyện" : "Phường/Xã")) + ' --</option>';
          array.forEach(element => {
              row += `<option value="${element.code}">${element.name}</option>`
          });
          document.querySelector("#" + select).innerHTML = row;
      }

      // Khi chọn Tỉnh -> Load Huyện
      document.querySelector("#province").addEventListener("change", () => {
          let provinceCode = document.querySelector("#province").value;
          const districtSelect = document.querySelector("#district");
          const wardSelect = document.querySelector("#ward");
          
          districtSelect.innerHTML = '<option value="">-- Đang tải... --</option>';
          wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
          wardSelect.disabled = true;

          if(provinceCode) {
              callApiDistrict(host + "p/" + provinceCode + "?depth=2");
              districtSelect.disabled = false;
          } else {
              districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
              districtSelect.disabled = true;
          }
      });

      // Khi chọn Huyện -> Load Xã
      document.querySelector("#district").addEventListener("change", () => {
          let districtCode = document.querySelector("#district").value;
          const wardSelect = document.querySelector("#ward");
          
          wardSelect.innerHTML = '<option value="">-- Đang tải... --</option>';

          if(districtCode) {
              callApiWard(host + "d/" + districtCode + "?depth=2");
              wardSelect.disabled = false;
          } else {
              wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
              wardSelect.disabled = true;
          }
      });

      // ==========================================
      // 2. VALIDATE FORM
      // ==========================================
      function validateForm() {
        let isValid = true;
        const errors = {};

        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const specificAddress = document.getElementById('specificAddress').value.trim();
        
        // Lấy giá trị 3 ô chọn
        const province = document.getElementById('province').value;
        const district = document.getElementById('district').value;
        const ward = document.getElementById('ward').value;

        const paymentMethodEl = document.querySelector('input[name="payment"]:checked');
        const paymentMethod = paymentMethodEl ? paymentMethodEl.value : '';

        // Reset lỗi cũ
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

        if (!fullName) {
          document.getElementById('fullName-error').textContent = 'Vui lòng điền họ và tên đầy đủ!';
          document.getElementById('fullName-error').style.display = 'block';
          isValid = false;
        }

        if (!phone) {
          document.getElementById('phone-error').textContent = 'Vui lòng điền số điện thoại!';
          document.getElementById('phone-error').style.display = 'block';
          isValid = false;
        } else if (!/^[0-9]{10,11}$/.test(phone)) {
          document.getElementById('phone-error').textContent = 'Số điện thoại phải là 10-11 số!';
          document.getElementById('phone-error').style.display = 'block';
          isValid = false;
        }

        // Kiểm tra đã chọn đủ 3 cấp hành chính chưa
        if (!province || !district || !ward) {
            document.getElementById('area-error').textContent = 'Vui lòng chọn đầy đủ Tỉnh, Huyện, Xã!';
            document.getElementById('area-error').style.display = 'block';
            isValid = false;
        }

        if (!specificAddress) {
          document.getElementById('address-error').textContent = 'Vui lòng điền địa chỉ cụ thể (số nhà, đường)!';
          document.getElementById('address-error').style.display = 'block';
          isValid = false;
        }

        if (!paymentMethod) {
          alert('Vui lòng chọn phương thức thanh toán!');
          isValid = false;
        }

        if (!isValid) {
          const firstError = document.querySelector('.error-message[style*="block"]');
          if (firstError) firstError.scrollIntoView({ behavior: 'smooth' });
        }

        return isValid;
      }

      // ==========================================
      // 3. XỬ LÝ ĐẶT HÀNG (PLACE ORDER)
      // ==========================================
      async function placeOrder() {
        if (!validateForm()) return;

        const btnBuy = document.getElementById('place-order-btn');
        const originalContent = btnBuy.innerHTML;
        btnBuy.innerHTML = '<span>Đang xử lý...</span> <i class="fas fa-spinner fa-spin"></i>';
        btnBuy.disabled = true;

        // Lấy Text hiển thị của 3 ô chọn (Ví dụ: "Hà Nội", "Ba Đình") thay vì lấy mã code
        const provinceText = document.querySelector("#province option:checked").text;
        const districtText = document.querySelector("#district option:checked").text;
        const wardText = document.querySelector("#ward option:checked").text;
        
        // Lấy địa chỉ cụ thể
        const specificAddress = document.getElementById('specificAddress').value.trim();

        // [QUAN TRỌNG] Gộp thành chuỗi địa chỉ đầy đủ để gửi Server
        const fullAddressString = `${specificAddress}, ${wardText}, ${districtText}, ${provinceText}`;

        // Lấy các thông tin khác
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const note = document.getElementById('note').value.trim();
        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;

        try {
          const response = await fetch('/checkout/orders/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customer: { 
                  fullName, 
                  phone, 
                  address: fullAddressString, // Gửi chuỗi địa chỉ đã gộp
                  note 
              },
              paymentMethod
            })
          });

          const data = await response.json();

          if (data.success) {
            // XỬ LÝ CHUYỂN HƯỚNG
            if (data.paymentUrl) {
              // Nếu là VNPay -> Redirect sang ngân hàng
              window.location.href = data.paymentUrl;
            } else {
              // Nếu là COD -> Sang trang cảm ơn
              alert('Đặt hàng thành công! Mã đơn: ' + data.orderId);
              window.location.href = data.redirectUrl || `/checkout/orders/order-complete?orderId=${data.orderId}`;
            }
          } else {
            alert('Lỗi: ' + (data.message || 'Không thể đặt hàng'));
            btnBuy.innerHTML = originalContent;
            btnBuy.disabled = false;
          }

        } catch (error) {
          console.error(error);
          alert('Lỗi hệ thống. Vui lòng thử lại sau.');
          btnBuy.innerHTML = originalContent;
          btnBuy.disabled = false;
        }
      }
    </script>
</body>

</html>
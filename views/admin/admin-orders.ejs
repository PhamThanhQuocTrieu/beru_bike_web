<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= title %>
  </title>
  <link rel="stylesheet" href="/style/admin.css">
  <link rel="stylesheet" href="/style/admin-orders.css">
  <link rel="icon" type="image/x-icon" href="/image/logo/favicon.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .admin-avatar-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e0e7ff;
    }

    /* Style cho các nút hành động Admin */
    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: opacity 0.2s;
    }

    .btn-icon:hover {
      opacity: 0.8;
    }

    .btn-confirm {
      background-color: #17a2b8;
    }

    /* Màu xanh dương nhạt: Xác nhận */
    .btn-ship {
      background-color: #ffc107;
      color: #333;
    }

    /* Màu vàng: Giao hàng */
    .btn-complete {
      background-color: #28a745;
    }

    /* Màu xanh lá: Hoàn thành */
    .btn-approve {
      background-color: #28a745;
    }

    .btn-reject {
      background-color: #6c757d;
    }

    .btn-admin-cancel {
      background-color: #dc3545;
    }

    /* Màu đỏ: Hủy */

    /* Badge trạng thái - Đồng bộ màu sắc với Client */
    .badge {
      padding: 5px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      display: inline-block;
      min-width: 90px;
      text-align: center;
    }

    .status-pending {
      background-color: #ffc107;
      color: #333;
    }

    .status-confirmed {
      background-color: #17a2b8;
    }

    .status-shipping {
      background-color: #007bff;
    }

    .status-completed {
      background-color: #28a745;
    }

    .status-cancelled {
      background-color: #dc3545;
    }

    .status-request_cancel {
      background-color: #d81717;
    }
  </style>
</head>

<body>

  <header class="header">
    <div class="header-container">
      <div class="logo"><span>Admin Beru Bike</span></div>
      <nav class="header-nav">
        <ul>
          <li><a href="/admin">Dashboard</a></li>
          <li><a href="/admin/products">Sản phẩm</a></li>
          <li><a href="/admin/orders" class="active">Đơn hàng</a></li>
          <li><a href="/admin/users">Người dùng</a></li>
        </ul>
      </nav>
      <div class="user-profile">
        <% if (user.avatar && user.avatar.trim() !=='' ) { %>
          <img src="<%= user.avatar %>" alt="Admin Avatar" class="admin-avatar-img">
          <% } else { %>
            <div class="avatar-circle">
              <%= user.firstName.charAt(0).toUpperCase() %>
            </div>
            <% } %>
              <div class="user-info-text">
                <span class="u-name">
                  <%= user.firstName %>
                    <%= user.lastName %>
                </span>
                <span class="u-role">Administrator</span>
              </div>
              <a href="/auth/logout" class="logout-btn" title="Đăng xuất"><i class="fas fa-sign-out-alt"></i></a>
      </div>
    </div>
  </header>

  <aside class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="/admin/dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="/admin/products"><i class="fas fa-box"></i> Sản phẩm</a></li>
      <li><a href="/admin/orders" class="active"><i class="fas fa-shopping-cart"></i> Đơn hàng</a></li>
      <li><a href="/admin/users"><i class="fas fa-users"></i> Khách hàng</a></li>
      <li style="margin-top: auto;"><a href="/admin/settings"><i class="fas fa-cog"></i> Cài đặt</a></li>
    </ul>
  </aside>

  <main class="main-content">
    <div class="container">
      <h1 class="page-title">Quản lý đơn hàng</h1>

      <% if (!orders || orders.length===0) { %>
        <div style="text-align:center; padding: 50px; color: #666;">
          <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 10px;"></i>
          <p>Chưa có đơn hàng nào trong hệ thống.</p>
        </div>
        <% } else { %>
          <div style="overflow-x: auto;">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Mã đơn</th>
                  <th>Khách hàng</th>
                  <th>Sản phẩm</th>
                  <th>Tổng tiền / Trạng thái</th>
                  <th>Trạng thái</th>
                  <th>Hành động (Duyệt)</th>
                </tr>
              </thead>
              <tbody>
                <% orders.forEach(order=> { %>
                  <tr>
                    <td>
                      <strong>#<%= order._id.toString().slice(-6).toUpperCase() %></strong>
                      <div style="font-size: 11px; color: #888; margin-top: 4px;">
                        <%= new Date(order.createdAt).toLocaleDateString('vi-VN') %><br>
                          <%= new Date(order.createdAt).toLocaleTimeString('vi-VN', {hour: '2-digit' ,
                            minute:'2-digit'}) %>
                      </div>
                    </td>

                    <td>
                      <div class="customer-info">
                        <strong>
                          <%= order.shippingAddress.fullName %>
                        </strong>
                        <small style="display:block; color:#666">
                          <%= order.shippingAddress.phone %>
                        </small>
                        <div class="customer-address" style="font-size: 12px; color: #555; max-width: 200px;">
                          <%= order.shippingAddress.address %>
                        </div>
                      </div>
                    </td>

                    <td>
                      <% if(order.items && order.items.length> 0) { %>
                        <span style="font-size: 13px;">
                          <%= order.items[0].name %>
                        </span>
                        <% if(order.items.length> 1) { %>
                          <small style="color: #666;">(+<%= order.items.length - 1 %> món khác)</small>
                          <% } %>
                            <% } %>
                    </td>

                    <td>
                      <div class="price-text" style="color:#d0011b; font-weight:bold;">
                        <%= order.totalPrice.toLocaleString('vi-VN') %> đ
                      </div>
                      <div style="margin-top: 5px;">
                        <span style="font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 4px;">
                          <%= order.paymentMethod==='vnpay' ? 'VNPAY' : 'COD' %>
                        </span>
                        <br>
                        <% if (order.paymentStatus==='paid' ) { %>
                          <span style="color: green; font-size: 11px; font-weight: bold;">✔ Đã thanh toán</span>
                          <% } else if (order.paymentStatus==='failed' ) { %>
                            <span style="color: red; font-size: 11px;">✖ Thất bại</span>
                            <% } else { %>
                              <span style="color: orange; font-size: 11px;">Chờ thanh toán</span>
                              <% } %>
                      </div>
                    </td>

                    <td>
                      <% let statusLabel='' ; switch(order.status) { case 'pending' : statusLabel='Chờ xử lý' ; break;
                        case 'confirmed' : statusLabel='Đã xác nhận' ; break; // [MỚI] case 'shipping' :
                        statusLabel='Đang giao' ; break; case 'completed' : statusLabel='Hoàn thành' ; break;
                        case 'cancelled' : statusLabel='Đã hủy' ; break; case 'request_cancel' :
                        statusLabel='Yêu cầu hủy' ; break; default: statusLabel=order.status; } %>
                        <span class="badge status-<%= order.status %>">
                          <%= statusLabel %>
                        </span>
                    </td>

                    <td>
                      <div class="action-group" style="display: flex; gap: 5px;">

                        <% if (order.status==='request_cancel' ) { %>
                          <form action="/admin/orders/handle-cancel" method="POST"
                            onsubmit="return confirm('Duyệt hủy đơn này?');">
                            <input type="hidden" name="orderId" value="<%= order._id %>">
                            <input type="hidden" name="action" value="approve">
                            <button type="submit" class="btn-icon btn-approve" title="Duyệt hủy"><i
                                class="fas fa-check"></i></button>
                          </form>
                          <form action="/admin/orders/handle-cancel" method="POST">
                            <input type="hidden" name="orderId" value="<%= order._id %>">
                            <input type="hidden" name="action" value="reject">
                            <button type="submit" class="btn-icon btn-reject" title="Từ chối hủy"><i
                                class="fas fa-times"></i></button>
                          </form>

                          <% } else if (order.status==='pending' ) { %>
                            <form action="/admin/orders/update-status" method="POST">
                              <input type="hidden" name="orderId" value="<%= order._id %>">
                              <input type="hidden" name="status" value="confirmed"> <button class="btn-icon btn-confirm"
                                title="Xác nhận & Chuẩn bị hàng">
                                <i class="fas fa-clipboard-check"></i>
                              </button>
                            </form>

                            <form action="/admin/orders/admin-cancel" method="POST"
                              onsubmit="return confirm('Bạn có chắc chắn muốn HỦY đơn hàng này?');">
                              <input type="hidden" name="orderId" value="<%= order._id %>">
                              <button class="btn-icon btn-admin-cancel" title="Hủy đơn"><i
                                  class="fas fa-trash-alt"></i></button>
                            </form>

                            <% } else if (order.status==='confirmed' ) { %>
                              <form action="/admin/orders/update-status" method="POST">
                                <input type="hidden" name="orderId" value="<%= order._id %>">
                                <input type="hidden" name="status" value="shipping"> <button class="btn-icon btn-ship"
                                  title="Bắt đầu giao hàng">
                                  <i class="fas fa-truck"></i>
                                </button>
                              </form>

                              <% } else if (order.status==='shipping' ) { %>
                                <form action="/admin/orders/update-status" method="POST">
                                  <input type="hidden" name="orderId" value="<%= order._id %>">
                                  <input type="hidden" name="status" value="completed"> <button
                                    class="btn-icon btn-complete" title="Xác nhận đã giao thành công">
                                    <i class="fas fa-check-circle"></i>
                                  </button>
                                </form>
                                <% } %>

                      </div>
                    </td>
                  </tr>
                  <% }) %>
              </tbody>
            </table>
          </div>
          <% } %>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 Admin Panel.</p>
    </div>
  </footer>
</body>

</html>
<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh toán - Beru Bike</title>
  <link rel="stylesheet" href="/style/checkout.css">
  <link rel="stylesheet" href="/style/footer.css">
  <link rel="stylesheet" href="/style/header.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/image/logo/favicon.png">

  <style>
    /* Style riêng cho logo thanh toán */
    .payment-option img { vertical-align: middle; margin-right: 10px; }

    /* [MỚI] Style cho 3 ô chọn địa lý */
    .address-selectors {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
    }
    .address-selectors select {
        flex: 1; /* Chia đều 3 ô */
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        outline: none;
        background: #fff;
        font-size: 14px;
        color: #333;
        height: 42px;
    }
    .address-selectors select:focus { border-color: #ee4d2d; }
    .address-selectors select:disabled { background-color: #f9f9f9; cursor: not-allowed; }

    /* Mobile: Xếp dọc */
    @media (max-width: 768px) {
        .address-selectors { flex-direction: column; }
    }
  </style>
</head>

<body>
  <%- include('header') %>

  <div class="container">
    <div class="checkout-progress">
      <div class="progress-step active">
        <div class="step-circle">1</div>
        <span>Giỏ hàng</span>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step">
        <div class="step-circle">2</div>
        <span>Thanh toán</span>
      </div>
      <div class="progress-line"></div>
      <div class="progress-step">
        <div class="step-circle">3</div>
        <span>Hoàn tất</span>
      </div>
    </div>

    <div class="checkout">
      <div class="checkout-left">
        
        <div id="cart-section" class="section active">
          <div class="box cart-box">
            <div class="cart-header">
              <h3><i class="fas fa-shopping-cart"></i> Giỏ hàng của bạn</h3>
              <span class="item-count">(<span id="cart-qty-display"><%= cartItems.length %></span> sản phẩm)</span>
            </div>

            <div id="cart-items-container">
              <% if (cartItems && cartItems.length > 0) { %>
                <% cartItems.forEach(item => { %>
                  <div class="cart-item" id="item-<%= item._id %>">
                    <img src="<%= item.image || '/image/icon/image.png' %>" alt="<%= item.name %>" class="item-image">
                    
                    <div class="item-info">
                      <p class="item-name"><%= item.name %></p>
                      <p class="item-price-display">₫<%= (item.price || 0).toLocaleString('vi-VN') %></p>
                      <% if(item.stock !== undefined) { %>
                         <small style="color: #666;">Kho còn: <%= item.stock %></small>
                      <% } %>
                    </div>
                    
                    <div class="item-actions">
                      <div class="item-quantity">
                        <button class="qty-btn" onclick="updateCartItem('<%= item._id %>', 'decrease')" title="Giảm số lượng">−</button>
                        <input type="number" id="qty-<%= item._id %>" class="qty-input" value="<%= item.quantity || 1 %>" readonly data-id="<%= item._id %>">
                        <button class="qty-btn" onclick="updateCartItem('<%= item._id %>', 'increase')" title="Tăng số lượng">+</button>
                      </div>

                      <button class="delete-btn" onclick="updateCartItem('<%= item._id %>', 'remove')" title="Xóa sản phẩm">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="empty-cart-msg">
                  <i class="fas fa-shopping-bag"></i>
                  <p>Giỏ hàng của bạn đang trống!</p>
                  <a href="/products" class="back-link"><i class="fas fa-arrow-left"></i> Quay lại mua sắm</a>
                </div>
              <% } %>
            </div>
          </div>
        </div>

        <div id="payment-section" class="section" style="display: none;">
          
          <div class="box order-review">
            <div class="cart-header">
              <h3><i class="fas fa-shopping-bag"></i> Đơn hàng của bạn</h3>
              <span class="item-count">(<span id="payment-cart-qty-display"><%= cartItems.length %></span> sản phẩm)</span>
            </div>
            <div id="payment-cart-items-container"></div>
          </div>

          <div class="box customer-info-box">
            <h3><i class="fas fa-user"></i> Thông tin giao hàng</h3>
            <form id="customerForm" class="customer-form" novalidate>
              <div class="form-row">
                <div class="form-group">
                  <label for="fullName">Họ và tên <span class="required">*</span></label>
                  <input type="text" id="fullName" name="fullName" value="<%= user ? (user.fullName || user.lastName + ' ' + user.firstName) : '' %>" placeholder="Họ và Tên" required>
                  <span class="error-message" id="fullName-error" style="display: none; color: red;"></span>
                </div>
                <div class="form-group">
                  <label for="phone">Số điện thoại <span class="required">*</span></label>
                  <input type="tel" id="phone" name="phone" value="<%= user ? user.phone : '' %>" placeholder="0123 456 789" required pattern="[0-9]{10,11}">
                  <span class="error-message" id="phone-error" style="display: none; color: red;"></span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full">
                    <label>Khu vực giao hàng <span class="required">*</span></label>
                    <div class="address-selectors">
                        <select id="province" name="province">
                            <option value="">-- Tỉnh/Thành phố --</option>
                        </select>
                        <select id="district" name="district" disabled>
                            <option value="">-- Quận/Huyện --</option>
                        </select>
                        <select id="ward" name="ward" disabled>
                            <option value="">-- Phường/Xã --</option>
                        </select>
                    </div>
                    <span class="error-message" id="area-error" style="display: none; color: red;"></span>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group full">
                  <label for="specificAddress">Địa chỉ cụ thể <span class="required">*</span></label>
                  <textarea id="specificAddress" name="specificAddress" placeholder="Số nhà, tên đường, tòa nhà..." required minlength="5"><%= user ? user.address : '' %></textarea>
                  <span class="error-message" id="address-error" style="display: none; color: red;"></span>
                  <span class="form-hint" style="font-size: 12px; color: #666;">Ví dụ: Số 10, Đường 3/2 (Không cần nhập lại Tỉnh/Thành)</span>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group full">
                  <label for="note">Ghi chú đơn hàng (Tùy chọn)</label>
                  <textarea id="note" name="note" placeholder="Ví dụ: Giao hàng vào sáng, có chuông cửa..."></textarea>
                </div>
              </div>
            </form>
          </div>

          <div class="box payment-box">
            <h3><i class="fas fa-credit-card"></i> Chọn hình thức thanh toán</h3>
            <div class="payment-options">
              
              <label class="payment-option">
                <input type="radio" name="payment" value="cod" checked>
                <div class="option-content">
                  <span class="option-title">
                    <img src="/image/icon/cod.png" alt="" width="38"> Thanh toán khi nhận hàng (COD)
                  </span>
                  <span class="option-desc">Thanh toán bằng tiền mặt khi nhận hàng</span>
                </div>
                <span class="checkmark"></span>
              </label>

              <label class="payment-option">
                <input type="radio" name="payment" value="vnpay">
                <div class="option-content">
                  <span class="option-title">
                    <img src="/image/icon/vnpay.png" alt="" width="50"> VNPay / Thẻ ATM / QR Code
                  </span>
                  <span class="option-desc">Thanh toán an toàn qua cổng VNPay</span>
                </div>
                <span class="checkmark"></span>
              </label>

            </div>
          </div>
        </div>
      </div>

      <div class="checkout-right">
        <div class="box order-total sticky-box">
          
          <div id="order-summary-box" class="summary active">
            <h3><i class="fas fa-receipt"></i> Tóm tắt đơn hàng</h3>
            <div class="summary">
              <div class="summary-row">
                <span>Tạm tính:</span>
                <span id="subtotal" class="subtotal-value">₫<%= (subtotal || 0).toLocaleString('vi-VN') %></span>
              </div>
              <div class="summary-divider"></div>
              <div class="summary-row total-row">
                <span>Tổng cộng:</span>
                <span id="totalAmount" class="total-amount">₫<%= (total || 0).toLocaleString('vi-VN') %></span>
              </div>
              <small class="shipping-notice"><i class="fas fa-info-circle"></i> Phí vận chuyển được tính ở bước thanh toán</small>
            </div>

            <% if (cartItems && cartItems.length > 0) { %>
              
              <button id="proceed-to-payment" class="btn-buy" onclick="toggleSection('payment')">
                <span>Tiến hành thanh toán</span> <i class="fas fa-arrow-right"></i>
              </button>
              
              <button id="place-order-btn" class="btn-buy" onclick="placeOrder()" style="display: none;">
                <span>ĐẶT HÀNG NGAY</span> <i class="fas fa-check"></i>
              </button>

              <button id="back-to-cart" class="btn-back" onclick="toggleSection('cart')" style="display: none;">
                <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
              </button>

              <a href="/products" id="continue-shopping-btn" class="btn-continue-shopping">
                Tiếp tục mua sắm
              </a>

            <% } else { %>
              <button class="btn-buy" disabled><span>GIỎ HÀNG TRỐNG</span></button>
            <% } %>

            <% if (!user) { %>
              <div class="guest-notice">
                </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-bottom">
      <p>© 2025 Xe Đạp Beru Bike - Chất lượng & Uy tín</p>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

  <script>
    // ==========================================
    // 1. LOGIC API ĐỊA LÝ VIỆT NAM
    // ==========================================
    const host = "https://provinces.open-api.vn/api/";
    
    var callAPI = (api) => {
        return axios.get(api).then((response) => {
            renderData(response.data, "province");
        });
    }
    
    callAPI(host + "?depth=1"); // Load Tỉnh/Thành ngay khi vào

    var callApiDistrict = (api) => {
        return axios.get(api).then((response) => {
            renderData(response.data.districts, "district");
        });
    }
    
    var callApiWard = (api) => {
        return axios.get(api).then((response) => {
            renderData(response.data.wards, "ward");
        });
    }

    var renderData = (array, select) => {
        let row = ' <option value="">-- Chọn ' + (select === "province" ? "Tỉnh/Thành" : (select === "district" ? "Quận/Huyện" : "Phường/Xã")) + ' --</option>';
        array.forEach(element => {
            row += `<option value="${element.code}">${element.name}</option>`
        });
        document.querySelector("#" + select).innerHTML = row;
    }

    // Sự kiện chọn Tỉnh -> Load Huyện
    document.querySelector("#province").addEventListener("change", () => {
        let provinceCode = document.querySelector("#province").value;
        const districtSelect = document.querySelector("#district");
        const wardSelect = document.querySelector("#ward");
        
        districtSelect.innerHTML = '<option value="">-- Đang tải... --</option>';
        wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
        wardSelect.disabled = true;

        if(provinceCode) {
            callApiDistrict(host + "p/" + provinceCode + "?depth=2");
            districtSelect.disabled = false;
        } else {
            districtSelect.innerHTML = '<option value="">-- Chọn Quận/Huyện --</option>';
            districtSelect.disabled = true;
        }
    });

    // Sự kiện chọn Huyện -> Load Xã
    document.querySelector("#district").addEventListener("change", () => {
        let districtCode = document.querySelector("#district").value;
        const wardSelect = document.querySelector("#ward");
        
        wardSelect.innerHTML = '<option value="">-- Đang tải... --</option>';

        if(districtCode) {
            callApiWard(host + "d/" + districtCode + "?depth=2");
            wardSelect.disabled = false;
        } else {
            wardSelect.innerHTML = '<option value="">-- Chọn Phường/Xã --</option>';
            wardSelect.disabled = true;
        }
    });

    // ==========================================
    // 2. CHUYỂN ĐỔI TAB
    // ==========================================
    function toggleSection(section) {
      const cartSection = document.getElementById('cart-section');
      const paymentSection = document.getElementById('payment-section');
      const progressSteps = document.querySelectorAll('.progress-step');
      
      const proceedBtn = document.getElementById('proceed-to-payment');
      const placeOrderBtn = document.getElementById('place-order-btn');
      const backBtn = document.getElementById('back-to-cart');
      const continueBtn = document.getElementById('continue-shopping-btn');

      if (section === 'payment') {
        cartSection.style.display = 'none';
        paymentSection.style.display = 'block';
        
        progressSteps[0].classList.remove('active');
        progressSteps[0].classList.add('completed');
        progressSteps[1].classList.add('active');
        
        proceedBtn.style.display = 'none';
        continueBtn.style.display = 'none';
        placeOrderBtn.style.display = 'block';
        backBtn.style.display = 'block';

        // COPY HTML GIỎ HÀNG
        const cartContent = document.getElementById('cart-items-container').cloneNode(true);
        const qtyBtns = cartContent.querySelectorAll('.qty-btn, .delete-btn');
        qtyBtns.forEach(btn => btn.remove());
        const inputs = cartContent.querySelectorAll('.qty-input');
        inputs.forEach(inp => {
            const span = document.createElement('span');
            span.innerHTML = 'Số lượng: <strong>' + inp.value + '</strong>';
            inp.parentNode.replaceChild(span, inp);
        });
        document.getElementById('payment-cart-items-container').innerHTML = '';
        document.getElementById('payment-cart-items-container').appendChild(cartContent);

      } else {
        cartSection.style.display = 'block';
        paymentSection.style.display = 'none';
        
        progressSteps[0].classList.add('active');
        progressSteps[0].classList.remove('completed');
        progressSteps[1].classList.remove('active');
        
        proceedBtn.style.display = 'block';
        continueBtn.style.display = 'block';
        placeOrderBtn.style.display = 'none';
        backBtn.style.display = 'none';
      }
    }

    // ==========================================
    // 3. CẬP NHẬT GIỎ HÀNG
    // ==========================================
    async function updateCartItem(productId, action) {
      document.body.style.cursor = 'wait';
      try {
        const inputEl = document.getElementById(`qty-${productId}`);
        let currentQty = inputEl ? parseInt(inputEl.value) : 1;
        let newQty = currentQty;

        if (action === 'increase') newQty++;
        if (action === 'decrease') newQty--;
        
        if (action === 'remove' || newQty < 1) {
            if (!confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
                document.body.style.cursor = 'default';
                return;
            }
            action = 'remove';
        } else {
            action = 'update';
        }

        const response = await fetch('/checkout/cart/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, id: productId, quantity: newQty })
        });

        const data = await response.json();

        if (data.success) {
          if (action === 'remove') {
             const itemRow = document.getElementById(`item-${productId}`);
             if (itemRow) itemRow.remove();
             if (data.cart.length === 0) window.location.reload();
          } else {
             if (inputEl) inputEl.value = newQty;
          }
          // Cập nhật UI
          const formattedTotal = data.subtotal.toLocaleString('vi-VN');
          document.getElementById('subtotal').innerText = `₫${formattedTotal}`;
          document.getElementById('totalAmount').innerText = `₫${formattedTotal}`;
          document.getElementById('cart-qty-display').innerText = data.cart.length;
          document.getElementById('payment-cart-qty-display').innerText = data.cart.length;
          const headerBadge = document.getElementById('cartCount');
          if(headerBadge) headerBadge.innerText = data.totalItems || data.cart.length;
        } else {
          alert('Lỗi: ' + data.message);
        }
      } catch (error) {
        console.error(error);
        alert('Lỗi kết nối server!');
      } finally {
        document.body.style.cursor = 'default';
      }
    }

    // ==========================================
    // 4. VALIDATE & ĐẶT HÀNG
    // ==========================================
    async function placeOrder() {
      // Validate Form
      let isValid = true;
      const fullName = document.getElementById('fullName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const specificAddress = document.getElementById('specificAddress').value.trim();
      const note = document.getElementById('note').value.trim();
      
      const province = document.getElementById('province').value;
      const district = document.getElementById('district').value;
      const ward = document.getElementById('ward').value;

      const paymentMethodEl = document.querySelector('input[name="payment"]:checked');
      const paymentMethod = paymentMethodEl ? paymentMethodEl.value : 'cod';

      // Reset Error
      document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

      if (!fullName) {
        document.getElementById('fullName-error').textContent = 'Vui lòng điền họ tên!';
        document.getElementById('fullName-error').style.display = 'block';
        isValid = false;
      }
      if (!phone) {
        document.getElementById('phone-error').textContent = 'Vui lòng điền SĐT!';
        document.getElementById('phone-error').style.display = 'block';
        isValid = false;
      }
      
      // Check 3 cấp địa lý
      if (!province || !district || !ward) {
        document.getElementById('area-error').textContent = 'Vui lòng chọn đầy đủ Tỉnh, Huyện, Xã!';
        document.getElementById('area-error').style.display = 'block';
        isValid = false;
      }

      if (!specificAddress) {
        document.getElementById('address-error').textContent = 'Vui lòng điền địa chỉ cụ thể!';
        document.getElementById('address-error').style.display = 'block';
        isValid = false;
      }

      if (!isValid) return;

      // ===========================
      // XỬ LÝ GỬI ĐƠN
      // ===========================
      const btn = document.getElementById('place-order-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span>Đang xử lý...</span> <i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;

      // 1. Lấy text hiển thị của Tỉnh/Huyện/Xã
      const provinceText = document.querySelector("#province option:checked").text;
      const districtText = document.querySelector("#district option:checked").text;
      const wardText = document.querySelector("#ward option:checked").text;

      // 2. Gộp địa chỉ đầy đủ
      const fullAddressString = `${specificAddress}, ${wardText}, ${districtText}, ${provinceText}`;

      try {
        const response = await fetch('/checkout/orders/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer: { fullName, phone, address: fullAddressString, note },
            paymentMethod
          })
        });

        const data = await response.json();

        if (data.success) {
          if (data.paymentUrl) {
             window.location.href = data.paymentUrl;
          } else {
             alert('Đặt hàng thành công! Mã đơn: ' + data.orderId);
             window.location.href = data.redirectUrl || `/checkout/orders/order-complete?orderId=${data.orderId}`;
          }
        } else {
          alert('Lỗi: ' + (data.message || 'Không thể đặt hàng'));
          btn.innerHTML = originalText;
          btn.disabled = false;
        }

      } catch (error) {
        console.error(error);
        alert('Lỗi hệ thống. Vui lòng thử lại.');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
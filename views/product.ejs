<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="/style/header.css">
    <link rel="stylesheet" href="/style/product.css">
    <link rel="stylesheet" href="/style/footer.css">
    <link rel="icon" type="image/x-icon" href="/image/logo/favicon.png">
    
    <style>
        /* --- PAGINATION STYLES --- */
        .pagination-container {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .page-btn, .page-number {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 40px;
            height: 40px;
            border: 1px solid #e0e0e0;
            background-color: #fff;
            color: #555;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            font-size: 14px;
            padding: 0;
        }

        .page-btn {
            width: auto;
            padding: 0 15px;
        }

        .page-btn:hover, .page-number:hover {
            background-color: #f8f9fa;
            border-color: #ccc;
            color: #ee4d2d;
        }

        .page-number.active {
            background-color: #ee4d2d;
            color: #fff;
            border-color: #ee4d2d;
        }

        .page-btn.disabled, .page-number.disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <%- include('header') %>

    <main class="product-page">
        <div class="container">
            <div class="breadcrumb">
                <a href="/">Trang chủ</a>
                <span>/</span>
                <% if (typeof keyword !=='undefined' && keyword) { %>
                    <span>Sản Phẩm / Kết quả tìm kiếm</span>
                <% } else { %>
                    <span>Sản Phẩm</span>
                <% } %>
            </div>

            <div class="product-layout">
                <aside class="sidebar">
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <span class="icon">⊖</span>
                            Thương Hiệu
                        </h3>
                        <div class="filter-options">
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="giant">
                                <img src="/image/logo_hang_xe/giant.png" alt="Giant" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="trinx">
                                <img src="/image/logo_hang_xe/trinx.png" alt="Trinx" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="java">
                                <img src="/image/logo_hang_xe/java.png" alt="Java" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="vinbike">
                                <img src="/image/logo_hang_xe/vinbike.png" alt="VinBike" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="maxbike">
                                <img src="/image/logo_hang_xe/maxbike.png" alt="maxbike" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="liv">
                                <img src="/image/logo_hang_xe/liv.png" alt="liv" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="misaki">
                                <img src="/image/logo_hang_xe/misaki.png" alt="misaki" class="brand-logo">
                            </label>
                            <label class="checkbox-label brand-label">
                                <input type="checkbox" name="brand" value="raptor">
                                <img src="/image/logo_hang_xe/raptor.png" alt="Raptor" class="brand-logo">
                            </label>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">
                            <span class="icon">⊖</span>
                            Kiểu xe
                        </h3>
                        <div class="filter-options">
                            <label class="checkbox-label">
                                <input type="checkbox" name="bike-type" value="xe đạp cho trẻ em">
                                <span>Xe đạp trẻ em</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="bike-type" value="xe đạp địa hình">
                                <span>Xe đạp địa hình</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="bike-type" value="xe đạp đua">
                                <span>Xe đạp đua</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="bike-type" value="xe đạp thể thao">
                                <span>Xe đạp thể thao</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="bike-type" value="xe đạp đường phố">
                                <span>Xe đạp đường phố</span>
                            </label>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h3 class="filter-title">
                            <span class="icon">⊖</span>
                            Khoảng giá
                        </h3>
                        <div class="filter-options">
                            <label class="checkbox-label">
                                <input type="checkbox" name="price-range" value="2-3">
                                <span>Từ 2 ~ 3 triệu</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="price-range" value="3-6">
                                <span>Từ 3 ~ 6 triệu</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="price-range" value="6-15">
                                <span>Từ 6 ~ 15 triệu</span>
                            </label>
                        </div>
                    </div>
                </aside>

                <div class="product-content">
                    <% if (typeof keyword !=='undefined' && keyword) { %>
                        <h1>Kết quả tìm kiếm cho từ khoá: "<%= keyword %>"</h1>
                        <p class="count">Tìm thấy <%= total || 0 %> sản phẩm</p>
                    <% } else { %>
                        <p class="product-description">
                            Danh sách các sản phẩm được phân phối toàn quốc bởi Beru Bike.
                        </p>
                    <% } %>

                    <div id="loadingSpinner" class="loading" style="display: none;">
                        <p>Đang tải sản phẩm...</p>
                    </div>

                    <div class="product-grid" id="productGrid">
                        <% if (products && products.length > 0) { %>
                            <% products.forEach(product => { %>
                                <div class="product-card" data-id="<%= product._id %>">
                                    <img src="<%= product.mainImage || '/image/icon/no-image.png' %>" alt="<%= product.name %>">
                                    <h4><%= product.name %></h4>
                                    <div class="brand"><%= product.brand || '' %></div>
                                    <div class="price-wrapper">
                                        <% if (product.oldPrice && product.oldPrice > product.price) { %>
                                            <span class="old-price">₫<%= product.oldPrice.toLocaleString('vi-VN') %></span>
                                            <span class="discount">-<%= Math.round(((product.oldPrice - product.price) / product.oldPrice * 100)) %>%</span>
                                        <% } %>
                                        <span class="price">₫<%= (product.price || 0).toLocaleString('vi-VN') %></span>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p>Chưa có sản phẩm nào.</p>
                        <% } %>
                    </div>

                    <div id="pagination" class="pagination-container" style="<%= (typeof lastPage !== 'undefined' && lastPage > 1) ? 'display: flex;' : 'display: none;' %>">
                        <% if (typeof lastPage !== 'undefined' && lastPage > 1) { %>
                            <% if (currentPage > 1) { %>
                                <a href="?page=<%= currentPage - 1 %>" class="page-btn" onclick="event.preventDefault(); loadPage(<%= currentPage - 1 %>)">« Trước</a>
                            <% } %>

                            <% for(let i = 1; i <= lastPage; i++) { %>
                                <a href="?page=<%= i %>" 
                                   class="page-number <%= i === currentPage ? 'active' : '' %>"
                                   onclick="event.preventDefault(); loadPage(<%= i %>)">
                                   <%= i %>
                                </a>
                            <% } %>

                            <% if (currentPage < lastPage) { %>
                                <a href="?page=<%= currentPage + 1 %>" class="page-btn" onclick="event.preventDefault(); loadPage(<%= currentPage + 1 %>)">Tiếp »</a>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-col">
                <h4>THÔNG TIN</h4>
                <ul>
                    <li><a href="#">Giới thiệu</a></li>
                    <li><a href="#">Danh sách đại lý</a></li>
                    <li><a href="#">Địa điểm sửa chữa</a></li>
                    <li><a href="#">Chính sách bảo hành</a></li>
                    <li><a href="#">Chính sách thanh toán</a></li>
                    <li><a href="#">Chính sách vận chuyển và giao nhận</a></li>
                    <li><a href="#">Chính sách đổi trả và hoàn tiền</a></li>
                    <li><a href="#">Chính sách bảo mật thông tin</a></li>
                    <li><a href="#">Hoạt động cộng đồng</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>SẢN PHẨM</h4>
                <ul>
                    <li><a href="#">Xe Đạp Thể Thao</a></li>
                    <li><a href="#">Xe Đạp Phổ Thông</a></li>
                    <li><a href="#">Xe Đạp Trẻ Em</a></li>
                    <li><a href="#">Phụ Kiện</a></li>
                    <li><a href="#">Cannondale</a></li>
                </ul>

                <h4>TIN TỨC</h4>
                <ul>
                    <li><a href="#">Quan hệ cổ đông</a></li>
                    <li><a href="#">Tin tức công ty</a></li>
                    <li><a href="#">Tin tức xe đạp</a></li>
                    <li><a href="#">Tuyển dụng</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>LIÊN HỆ</h4>
                <p><b>NHÀ MÁY SẢN XUẤT:</b><br>Lô A2CN3, Cụm công nghiệp Tây Sơn Hiên, Phường An Hòa, TP.Cần Thơ</p>
                <p><b>CHI NHÁNH MIỀN NAM:</b><br>19/12C, Đường A!0, Khu công nghiệp Tân Hiệp, Quận Tân Bình, TP.HCM</p>
                <p>Email: <a href="mailto:brbike@gmail.com.vn">brbike@gmail.com.vn</a></p>
            </div>

            <div class="footer-col">
                <h4>CÔNG TY CỔ PHẦN BERU BIKE CẦN THƠ</h4>
                <p>GPKD Số 0130150828 - cấp ngày 28/08/2022</p>
                <p>Số 10B Lý Tự Trọng, Ninh Kiều, Cần Thơ</p>
                <h2>038 960 3429</h2>
                <div class="social">
                    <a href=""><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"></a>
                    <a href=""><img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YouTube"></a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>© <span id="year"></span> Xe Đạp Beru Bike</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Update Footer Year
            const yearSpan = document.getElementById('year');
            if(yearSpan) yearSpan.textContent = new Date().getFullYear();

            // Mobile Menu
            const menuToggle = document.querySelector('.mobile-menu-toggle');
            const mobileNav = document.querySelector('.mobile-nav');
            if (menuToggle && mobileNav) {
                menuToggle.addEventListener('click', function () {
                    mobileNav.classList.toggle('active');
                    menuToggle.classList.toggle('active');
                });
            }

            // Click Handler for Products
            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', function (e) {
                    if (e.target.closest('.add-btn')) return;
                    const id = this.dataset.id;
                    window.location.href = `/product-detail/${id}`;
                });
            });

            // Initial Filter Load from URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('brands') || urlParams.has('bikeTypes') || urlParams.has('priceRanges')) {
                if(urlParams.has('brands')) {
                    urlParams.get('brands').split(',').forEach(b => {
                        const el = document.querySelector(`input[name="brand"][value="${b}"]`);
                        if(el) el.checked = true;
                    });
                }
                if(urlParams.has('bikeTypes')) {
                    urlParams.get('bikeTypes').split(',').forEach(t => {
                        // Decode URI component để xử lý tiếng Việt trên URL
                        const decodedT = decodeURIComponent(t);
                        const el = document.querySelector(`input[name="bike-type"][value="${decodedT}"]`);
                        if(el) el.checked = true;
                    });
                }
                if(urlParams.has('priceRanges')) {
                    urlParams.get('priceRanges').split(',').forEach(p => {
                        const el = document.querySelector(`input[name="price-range"][value="${p}"]`);
                        if(el) el.checked = true;
                    });
                }
            }
        });

        // ================= FILTER & PAGINATION LOGIC =================

        let filterTimeout;

        function applyFilters() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                loadData(1);
            }, 300);
        }

        function loadPage(page) {
            loadData(page);
        }

        function loadData(page) {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('productGrid').style.opacity = '0.5';

            const brands = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(cb => cb.value);
            const bikeTypes = Array.from(document.querySelectorAll('input[name="bike-type"]:checked')).map(cb => cb.value);
            const priceRanges = Array.from(document.querySelectorAll('input[name="price-range"]:checked')).map(cb => cb.value);

            const params = new URLSearchParams();
            if (brands.length > 0) params.append('brands', brands.join(','));
            if (bikeTypes.length > 0) params.append('bikeTypes', bikeTypes.join(','));
            if (priceRanges.length > 0) params.append('priceRanges', priceRanges.join(','));
            params.append('page', page);

            const newUrl = `/products?${params.toString()}`;
            history.pushState({ brands, bikeTypes, priceRanges, page }, '', newUrl);

            fetch(`/products/filter?${params.toString()}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    updateProductGrid(data.products);
                    updatePagination(data);
                    updateCount(data.total);
                    
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('productGrid').style.opacity = '1';
                    
                    document.querySelector('.product-layout').scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error('Filter error:', error);
                    alert('Lỗi tải sản phẩm!');
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('productGrid').style.opacity = '1';
                });
        }

        function updateProductGrid(products) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = ''; 
            if (products.length > 0) {
                products.forEach(product => {
                    let priceHtml = '';
                    if (product.oldPrice && product.oldPrice > product.price) {
                        const discount = Math.round(((product.oldPrice - product.price) / product.oldPrice * 100));
                        priceHtml = `
                            <span class="old-price">₫${product.oldPrice.toLocaleString('vi-VN')}</span>
                            <span class="discount">-${discount}%</span>
                            <span class="price">₫${(product.price || 0).toLocaleString('vi-VN')}</span>
                        `;
                    } else {
                        priceHtml = `<span class="price">₫${(product.price || 0).toLocaleString('vi-VN')}</span>`;
                    }

                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.dataset.id = product._id;
                    card.innerHTML = `
                        <img src="${product.mainImage || '/image/icon/no-image.png'}" alt="${product.name}">
                        <h4>${product.name}</h4>
                        <div class="brand">${product.brand || ''}</div>
                        <div class="price-wrapper">${priceHtml}</div>
                    `;
                    
                    card.addEventListener('click', (e) => {
                        if (!e.target.closest('.add-btn')) {
                            window.location.href = `/product-detail/${product._id}`;
                        }
                    });
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<p>Không tìm thấy sản phẩm nào phù hợp.</p>';
            }
        }

        function updatePagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (data.totalPages > 1) {
                pagination.style.display = 'flex';

                if (data.currentPage > 1) {
                    const prev = createPageLink('« Trước', data.currentPage - 1);
                    pagination.appendChild(prev);
                }

                for (let i = 1; i <= data.totalPages; i++) {
                    const pageLink = createPageLink(i, i);
                    if (i === data.currentPage) pageLink.classList.add('active');
                    pagination.appendChild(pageLink);
                }

                if (data.currentPage < data.totalPages) {
                    const next = createPageLink('Tiếp »', data.currentPage + 1);
                    pagination.appendChild(next);
                }
            } else {
                pagination.style.display = 'none';
            }
        }

        function createPageLink(text, pageNum) {
            const a = document.createElement('a');
            a.href = `?page=${pageNum}`;
            a.className = typeof text === 'number' ? 'page-number' : 'page-btn';
            a.innerHTML = text;
            a.onclick = (e) => {
                e.preventDefault();
                loadPage(pageNum);
            };
            return a;
        }

        function updateCount(total) {
            const count = document.querySelector('.count');
            if (count) count.innerHTML = `Tìm thấy ${total} sản phẩm`;
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });

        window.addEventListener('popstate', function (e) {
            if (e.state) {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                
                if (e.state.brands) e.state.brands.forEach(b => {
                     const el = document.querySelector(`input[name="brand"][value="${b}"]`);
                     if(el) el.checked = true;
                });
                if (e.state.bikeTypes) e.state.bikeTypes.forEach(t => {
                     const el = document.querySelector(`input[name="bike-type"][value="${t}"]`);
                     if(el) el.checked = true;
                });
                if (e.state.priceRanges) e.state.priceRanges.forEach(p => {
                     const el = document.querySelector(`input[name="price-range"][value="${p}"]`);
                     if(el) el.checked = true;
                });
                
                loadData(e.state.page || 1);
            }
        });
    </script>
</body>
</html>